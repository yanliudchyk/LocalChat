# LocalChat – Анализ Вариантов Использования

## Актёры (Actors)

### **Пользователь (User)**
Базовая роль. Любой человек, открывший приложение. Может настраивать профиль, просматривать историю сообщений.

### **Хост (Host)**
Пользователь, выбравший роль "Сервер". Его устройство инициирует чат-комнату, открывает порт и ретранслирует сообщения другим участникам.

### **Клиент (Client)**
Пользователь, выбравший роль "Клиент". Подключается к Хосту по IP-адресу для участия в переписке.

### **Система (System)**
Само приложение LocalChat, выполняющее фоновые операции: валидацию ввода, работу с сетью (Socket/ServerSocket), сохранение настроек (SharedPreferences) и обновление UI (Compose).

---

## Сценарии Вариантов Использования (Use Case Scenarios)

### **UC1: Настройка профиля и выбор роли**

**Актёр:** Пользователь  
**Предусловие:** Пользователь находится в приложении, открыт диалог настроек.

**Поток событий (Flow of Events):**
1. Пользователь открывает диалог настроек (кнопка с шестеренкой).
2. Система отображает текущие настройки: Юзернейм, Роль, IP, Порт.
3. Пользователь вводит/изменяет имя (Юзернейм).
4. Пользователь выбирает роль (Хост или Клиент).
    - Если выбран **Хост**: поле IP скрывается или становится неактивным (используется локальный адрес).
    - Если выбран **Клиент**: поле IP активно для ввода.
5. Пользователь вводит номер Порта.
6. Пользователь нажимает кнопку "Сохранить и переподключиться".
7. Система валидирует данные:
   - Имя не пустое.
   - Порт в диапазоне 1024–65535.
   - IP-адрес имеет корректный формат (для Клиента).
8. Если валидация успешна, система сохраняет настройки в SharedPreferences.
9. Система инициирует перезапуск сетевой сессии (см. UC2 или UC3).

**Альтернативные потоки (Alternative Flows):**
- **Некорректный порт:** Система подсвечивает поле красным и блокирует сохранение ("Порт должен быть числом > 1024").
- **Пустое имя:** Система требует ввести имя.
- **Некорректный IP:** Система сообщает "Неверный формат IP-адреса".

**Постусловие:** Настройки обновлены, приложение начинает процедуру подключения с новыми параметрами.

---

### **UC2: Запуск сервера (Создание чата)**

**Актёр:** Хост  
**Предусловие:** В настройках выбрана роль "Хост", нажата кнопка "Сохранить".

**Поток событий (Flow of Events):**
1. Система считывает настройки (Порт).
2. Система запускает фоновую задачу (`Dispatchers.IO`).
3. Система открывает `ServerSocket` на указанном порту.
4. Система переходит в режим ожидания подключений (`accept()`).
5. Пользователю отображается пустой список сообщений (или системное сообщение "Сервер запущен").

**Альтернативные потоки (Alternative Flows):**
- **Порт занят:** Другое приложение уже использует этот порт. Пользователь получает уведомление "Ошибка: Порт занят". Сервер не запускается.
- **Нет сети:** Система уведомляет об ошибке сетевого интерфейса.

**Постусловие:** Устройство готово принимать входящие подключения от клиентов.

---

### **UC3: Подключение к чату**

**Актёр:** Клиент  
**Предусловие:** В настройках выбрана роль "Клиент", указан IP Хоста, нажата кнопка "Сохранить".

**Поток событий (Flow of Events):**
1. Система считывает настройки (IP, Порт).
2. Система пытается установить TCP-соединение (`Socket`) с указанным адресом.
3. Если соединение успешно, запускается цикл прослушивания входящих сообщений.
4. Пользователю отображается экран чата.

**Альтернативные потоки (Alternative Flows):**
- **Хост не найден / Тайм-аут:** Система не может подключиться в течение заданного времени. Пользователь получает уведомление "Не удалось подключиться к серверу".
- **Разрыв соединения:** Если связь теряется в процессе, система уведомляет "Связь с сервером потеряна".

**Постусловие:** Клиент подключен, канал связи открыт.

---

### **UC4: Отправка сообщения**

**Актёр:** Хост / Клиент  
**Предусловие:** Сетевое соединение установлено.

**Поток событий (Flow of Events):**
1. Пользователь вводит текст в поле ввода.
2. Пользователь нажимает кнопку отправки.
3. Система очищает поле ввода.
4. Система формирует объект сообщения (добавляет timestamp и юзернейм).
5. Сообщение мгновенно добавляется в локальный список чата.
6. Система сериализует сообщение.
7. Система отправляет данные в сетевой сокет.
    - Если отправитель **Клиент**: сообщение уходит Хосту.
    - Если отправитель **Хост**: сообщение рассылается всем подключенным Клиентам.

**Альтернативные потоки (Alternative Flows):**
- **Пустое сообщение:** Кнопка отправки неактивна или нажатие игнорируется.
- **Ошибка отправки:** Сокет закрыт или недоступен. Система может пометить сообщение как "Не отправлено" (опционально) или показать Toast "Ошибка сети".

**Постусловие:** Сообщение передано в сеть.

---

### **UC5: Получение и ретрансляция сообщения**

**Актёр:** Хост (как маршрутизатор)  
**Предусловие:** Сервер запущен, есть подключенные клиенты.

**Поток событий (Flow of Events):**
1. Система (на стороне Хоста) получает пакет данных от одного из Клиентов.
2. Система десериализует объект сообщения.
3. Система добавляет сообщение в список отображения Хоста.
4. Система пересылает (бродкастит) это сообщение всем остальным активным сокетам, кроме отправителя.

**Альтернативные потоки (Alternative Flows):**
- **Некорректные данные:** Пришел "мусор" вместо действительного сообщения. Система игнорирует пакет или пишет ошибку в лог.

**Постусловие:** Все участники чата видят новое сообщение.